import streamlit as st
import FinanceDataReader as fdr
import pandas as pd
import plotly.express as px

st.set_page_config(page_title="ë‚´ ì£¼ì‹ í˜„í™©íŒ", layout="wide")
st.title("ğŸš€ ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ ì‹¤ì‹œê°„ ë§µ")

# ---------------------------------------------------------
# â–¼â–¼ ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ ë°ì´í„° (ìŠ¤í¬ë¦°ìƒ· 8ì¥ ì™„ë²½ ë°˜ì˜) â–¼â–¼
# ì¤‘ë³µ ì¢…ëª©ì€ 'ìˆ˜ëŸ‰ í•©ì‚° & ê°€ì¤‘ í‰ê·  í‰ë‹¨ê°€'ë¡œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.
# ---------------------------------------------------------
my_portfolio = {
    'ì¢…ëª©ëª…': [
        # --- êµ­ë‚´ ì£¼ì‹ (17ê°œ) ---
        'ì‚¼ì„±ì „ì', 'SKí•˜ì´ë‹‰ìŠ¤', 'LIGë„¥ìŠ¤ì›', 'í•˜ë‚˜ê¸ˆìœµì§€ì£¼', 'í˜„ëŒ€ë¡œí…œ', 
        'í˜„ëŒ€ì°¨', 'ì˜¤ë¦¬ì˜¨', 'í•œí™”', 'LG', 'TIGER AIì „ë ¥ê¸°ê¸°', 
        'WON ì´ˆëŒ€í˜•IB', 'KT&G', 'KBê¸ˆìœµ', 'LGì „ì', 'íš¨ì„±ì¤‘ê³µì—…', 
        'HDí˜„ëŒ€ì¤‘ê³µì—…', 'KODEX ì£¼ì£¼í™˜ì›',
        # --- ë¯¸êµ­ ì£¼ì‹ (7ê°œ) ---
        'Alphabet C', 'Invesco QQQ', 'TQQQ', 'Tesla', 
        'Berkshire B', 'Zeta Global', 'Qualcomm'
    ],
    'ì¢…ëª©ì½”ë“œ': [
        # --- êµ­ë‚´ ì½”ë“œ ---
        '005930', '000660', '079550', '086790', '064350', 
        '005380', '271560', '000880', '003550', '0117V0', 
        '453470', '033780', '105560', '066570', '298040', 
        '329180', '476650',
        # --- ë¯¸êµ­ í‹°ì»¤ ---
        'GOOG', 'QQQ', 'TQQQ', 'TSLA', 
        'BRK-B', 'ZETA', 'QCOM'
    ],
    'ìˆ˜ëŸ‰': [
        # ì‚¼ì„±ì „ì(125+26), SKí•˜ì´ë‹‰ìŠ¤(12), LIG(13+26), í•˜ë‚˜ê¸ˆìœµ(58+56), í˜„ëŒ€ë¡œí…œ(20)
        151, 12, 39, 114, 20, 
        # í˜„ëŒ€ì°¨(11+16), ì˜¤ë¦¬ì˜¨(32), í•œí™”(24), LG(31+59), TIGER(500)
        27, 32, 24, 90, 500,
        # WON(1100), KT&G(80), KB(21), LGE(25), íš¨ì„±(2)
        1100, 80, 21, 25, 2,
        # HDí˜„ëŒ€(17), KODEX(800)
        17, 800,
        # êµ¬ê¸€(8+9), QQQ(2), TQQQ(3), í…ŒìŠ¬ë¼(4), ë²„í¬ì…”(2), ì œíƒ€(58), í€„ì»´(4)
        17, 2, 3, 4, 
        2, 58, 4
    ],
    'ë§¤ìˆ˜ë‹¨ê°€': [
        # ì¤‘ë³µ ì¢…ëª©ì€ ê°€ì¤‘ í‰ê· ê°’ ì ìš©
        117639, 736000, 523833, 98789, 196918, 
        388518, 115500, 125000, 88428, 14450, 
        10350, 147500, 132605, 106700, 2208000, 
        615235, 10430,
        # ë¯¸êµ­ ì£¼ì‹ (ë‹¬ëŸ¬ ê¸°ì¤€)
        287.55, 624.58, 54.50, 466.97, 
        493.98, 23.52, 182.39
    ]
}

@st.cache_data
def load_data():
    df = pd.DataFrame(my_portfolio)
    current_prices = []
    
    # í™˜ìœ¨ ì„¤ì • (1ë‹¬ëŸ¬ = 1450ì› ê°€ì •)
    exchange_rate = 1450 

    for code in df['ì¢…ëª©ì½”ë“œ']:
        try:
            # ë¯¸êµ­ ì£¼ì‹(ì•ŒíŒŒë²³)ê³¼ êµ­ë‚´ ì£¼ì‹(ìˆ«ì) êµ¬ë¶„
            stock_data = fdr.DataReader(code)
            price = stock_data['Close'].iloc[-1]
            
            # ì¢…ëª©ì½”ë“œê°€ ìˆ«ìê°€ ì•„ë‹ˆë©´(ë¯¸êµ­ì£¼ì‹) í™˜ìœ¨ ì ìš©
            if not code.isdigit() and not code.endswith('0'): 
                price = price * exchange_rate
            # ETF ì½”ë“œ(0117V0 ë“±)ëŠ” êµ­ë‚´ ì£¼ì‹ì´ì§€ë§Œ ë¬¸ì í¬í•¨ë  ìˆ˜ ìˆìŒ -> ì˜ˆì™¸ì²˜ë¦¬ ë¡œì§
            if code in ['0117V0']: # êµ­ë‚´ ETF ì˜ˆì™¸ ì²˜ë¦¬
                 price = price # ê·¸ëŒ€ë¡œ ì›í™” ì‚¬ìš©
                
            current_prices.append(price)
        except Exception as e:
            # ì—ëŸ¬ ë°œìƒ ì‹œ(ìƒì¥íì§€ ë“±) 0ì› ì²˜ë¦¬í•˜ê³  ë„˜ì–´ê°
            print(f"Error fetching {code}: {e}")
            current_prices.append(0)
    
    df['í˜„ì¬ê°€'] = current_prices
    
    # í‰ê°€ê¸ˆì•¡ ê³„ì‚°
    df['í‰ê°€ê¸ˆì•¡'] = df['í˜„ì¬ê°€'] * df['ìˆ˜ëŸ‰']
    
    # ë§¤ìˆ˜ë‹¨ê°€ ê³„ì‚°ìš© (ë¯¸êµ­ ì£¼ì‹ì€ í™˜ìœ¨ ê³±í•´ì„œ ë¹„êµ)
    df['ë§¤ìˆ˜ë‹¨ê°€_ì›í™”'] = df.apply(lambda x: x['ë§¤ìˆ˜ë‹¨ê°€'] * exchange_rate if (not str(x['ì¢…ëª©ì½”ë“œ']).isdigit() and x['ì¢…ëª©ì½”ë“œ'] not in ['0117V0']) else x['ë§¤ìˆ˜ë‹¨ê°€'], axis=1)
    
    # ìˆ˜ìµë¥  ê³„ì‚°
    df['ìˆ˜ìµë¥ (%)'] = ((df['í˜„ì¬ê°€'] - df['ë§¤ìˆ˜ë‹¨ê°€_ì›í™”']) / df['ë§¤ìˆ˜ë‹¨ê°€_ì›í™”']) * 100
    
    return df

if st.button('ğŸ”„ ì‹œì„¸ ìƒˆë¡œê³ ì¹¨'):
    st.cache_data.clear()

try:
    df_result = load_data()
    
    # ì´ ìì‚° í‘œì‹œ (ë©‹ì§„ ìˆ«ìë¡œ!)
    total_asset = df_result['í‰ê°€ê¸ˆì•¡'].sum()
    st.metric(label="ğŸ’° ë‚´ ì´ ìì‚° (ì¶”ì •)", value=f"{total_asset:,.0f} ì›")

    # íŠ¸ë¦¬ë§µ ê·¸ë¦¬ê¸°
    fig = px.treemap(
        df_result, 
        path=['ì¢…ëª©ëª…'], 
        values='í‰ê°€ê¸ˆì•¡', 
        color='ìˆ˜ìµë¥ (%)',
        color_continuous_scale=['#FF4B4B', '#F0F2F6', '#00CC96'], # ë¹¨ê°•(ì†ì‹¤) -> íšŒìƒ‰ -> ì´ˆë¡(ì´ìµ)
        color_continuous_midpoint=0
    )
    
    # ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ë³´ì—¬ì¤„ ì •ë³´ ì„œì‹
    fig.data[0].textinfo = 'label+text+value'
    fig.data[0].texttemplate = "%{label}<br>%{customdata[0]:.2f}%"
    fig.data[0].customdata = df_result[['ìˆ˜ìµë¥ (%)']]
    
    st.plotly_chart(fig, use_container_width=True)
    
    # í‘œë¡œ ìì„¸íˆ ë³´ê¸°
    st.subheader("ğŸ“Š ë³´ìœ  ì¢…ëª© ìƒì„¸")
    st.dataframe(
        df_result[['ì¢…ëª©ëª…', 'ìˆ˜ëŸ‰', 'í˜„ì¬ê°€', 'ìˆ˜ìµë¥ (%)', 'í‰ê°€ê¸ˆì•¡']].style.format({
            'í˜„ì¬ê°€': '{:,.0f}', 
            'í‰ê°€ê¸ˆì•¡': '{:,.0f}', 
            'ìˆ˜ìµë¥ (%)': '{:.2f}%'
        })
    )
    
except Exception as e:
    st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
